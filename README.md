# Домашнее задание к занятию «Микросервисы: подходы» -Филатов А. В.

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.


## Задача 1: Обеспечить разработку

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка. 
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- облачная система;
- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из системы контроля версий;
- запуск сборки по кнопке с указанием параметров;
- возможность привязать настройки к каждой сборке;
- возможность создания шаблонов для различных конфигураций сборок;
- возможность безопасного хранения секретных данных (пароли, ключи доступа);
- несколько конфигураций для сборки из одного репозитория;
- кастомные шаги при сборке;
- собственные докер-образы для сборки проектов;
- возможность развернуть агентов сборки на собственных серверах;
- возможность параллельного запуска нескольких сборок;
- возможность параллельного запуска тестов.

Обоснуйте свой выбор.

### Решенеи 1

Для реализации инфраструктуры для разработки в микросервисной архитектуре я предлагаю использовать следующие компоненты:

1. **GitLab** (или GitHub Enterprise) — для хранения исходного кода и организации CI/CD (непрерывная интеграция и доставка).
2. **GitLab CI/CD** (или GitHub Actions) — для организации процессов сборки, тестирования и деплоя.
3. **Docker Registry** — для хранения собственных докер-образов, используемых в сборке проектов.
4. **HashiCorp Vault** — для безопасного хранения секретных данных.

#### Архитектура и взаимодействие компонентов:

- **Система контроля версий Git**: GitLab или GitHub используют Git для управления версиями кода. Каждому микросервису создается отдельный репозиторий.
- **Запуск сборки по событию**: Каждая сборка может быть инициирована автоматически по событию (например, push в основную ветку или создание PR).
- **Запуск сборки по кнопке**: GitLab CI или GitHub Actions предоставляют возможность ручного запуска сборок с параметрами.
- **Шаблоны для сборок**: GitLab CI позволяет создавать шаблоны для конфигурации сборок с использованием YAML-файлов, что упрощает настройку многоразовых конфигураций для разных микросервисов.
- **Хранение секретных данных**: HashiCorp Vault интегрируется с CI/CD системами для безопасного хранения и использования ключей, паролей и токенов во время сборок.
- **Кастомные шаги и Docker-образы**: Использование Docker в CI/CD позволяет создавать и использовать собственные образы для сборки и тестирования проектов, гарантируя одинаковую среду выполнения.
- **Развертывание агентов сборки**: GitLab Runner (или self-hosted GitHub Runners) может быть развернут на собственных серверах, что позволяет гибко управлять мощностями и нагрузкой на сборочные машины.
- **Параллельный запуск сборок и тестов**: В GitLab CI и GitHub Actions есть возможность параллельного выполнения задач, что ускоряет общий процесс CI/CD.

#### Обоснование выбора:
- **GitLab** и **GitHub** — это зрелые, облачные платформы, поддерживающие Git и обладающие мощными инструментами для CI/CD.
- **HashiCorp Vault** — для безопасного хранения секретов, обеспечивает возможность централизованного управления доступами и ключами.
- Платформы предоставляют возможность использования собственных докер-образов для унификации окружений разработки и тестирования, а также поддержку агентов сборки на собственных серверах для гибкости инфраструктуры.

## Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
- минимальные требования к приложениям, сбор логов из stdout;
- гарантированная доставка логов до центрального хранилища;
- обеспечение поиска и фильтрации по записям логов;
- обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
- возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.

### Решение 2

Для сбора и анализа логов я предлагаю следующее решение:

1. **ELK Stack (Elasticsearch + Logstash + Kibana)** — для хранения и анализа логов.
2. **Filebeat** — для сбора логов с хостов.

#### Архитектура и взаимодействие компонентов:

- **Сбор логов в центральное хранилище**: Filebeat собирает логи со всех хостов, обслуживающих систему, и отправляет их в Logstash, который передает данные в Elasticsearch.
- **Минимальные требования к приложениям**: Приложения выводят логи в стандартный поток (stdout), а Filebeat автоматически их захватывает и передает.
- **Гарантированная доставка логов**: Logstash гарантирует доставку логов в Elasticsearch. В случае сетевых сбоев возможна буферизация на стороне Filebeat или Logstash.
- **Поиск и фильтрация**: Elasticsearch обеспечивает быструю индексацию и поиск по данным, Kibana предоставляет удобный интерфейс для поиска и визуализации логов.
- **Пользовательский интерфейс**: Kibana предоставляет разработчикам и администраторам удобный интерфейс для работы с логами, включая фильтрацию, поиск и настройку визуализаций.
- **Ссылки на сохраненные поиски**: Kibana позволяет сохранять поисковые запросы и предоставлять ссылки на них для дальнейшего использования.

#### Обоснование выбора:
- **ELK Stack** — это популярное и зрелое решение для логирования в распределенных системах, которое легко интегрируется с микросервисами. Оно обеспечивает удобный поиск и анализ данных с поддержкой множества метрик.
- **Filebeat** — легковесное и эффективное решение для сбора логов, минимально нагружает хосты и гарантирует доставку данных.

## Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- сбор метрик со всех хостов, обслуживающих систему;
- сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- сбор метрик, специфичных для каждого сервиса;
- пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.

Обоснуйте свой выбор.

### Решение 3

Для мониторинга состояния хостов и сервисов предлагаю следующее решение:

1. **Prometheus** — для сбора и хранения метрик.
2. **Grafana** — для визуализации метрик.
3. **Alertmanager** — для уведомлений на основе метрик.

#### Архитектура и взаимодействие компонентов:

- **Сбор метрик с хостов**: Prometheus собирает метрики состояния ресурсов хостов (CPU, RAM, HDD, Network) с помощью встроенных экспортеров.
- **Сбор метрик с микросервисов**: Для каждого микросервиса можно настроить метрики специфических параметров (например, количество запросов, время ответа), используя Prometheus client libraries.
- **Пользовательский интерфейс**: Grafana используется для визуализации метрик. В ней можно настроить дашборды с различными панелями для отображения состояния системы.
- **Запросы и агрегация**: Prometheus поддерживает мощный язык запросов PromQL для выполнения сложных аналитических запросов и агрегирования данных.
- **Alertmanager**: Интегрируется с Prometheus для настройки алертинга, чтобы отправлять уведомления при превышении пороговых значений метрик.

#### Обоснование выбора:
- **Prometheus и Grafana** — это открытые, высокопроизводительные инструменты мониторинга, которые широко используются в микросервисной архитектуре. Они позволяют легко собирать метрики, настраивать визуализации и мониторинг с поддержкой алертинга.
- **Prometheus** поддерживает кастомные метрики для каждого микросервиса и масштабируется в зависимости от нагрузки системы.

## Задача 4: Логи * (необязательная)

Продолжить работу по задаче API Gateway: сервисы, используемые в задаче, пишут логи в stdout. 

Добавить в систему сервисы для сбора логов Vector + ElasticSearch + Kibana со всех сервисов, обеспечивающих работу API.

### Результат выполнения: 

docker compose файл, запустив который можно перейти по адресу http://localhost:8081, по которому доступна Kibana.
Логин в Kibana должен быть admin, пароль qwerty123456.


## Задача 5: Мониторинг * (необязательная)

Продолжить работу по задаче API Gateway: сервисы, используемые в задаче, предоставляют набор метрик в формате prometheus:

- сервис security по адресу /metrics,
- сервис uploader по адресу /metrics,
- сервис storage (minio) по адресу /minio/v2/metrics/cluster.

Добавить в систему сервисы для сбора метрик (Prometheus и Grafana) со всех сервисов, обеспечивающих работу API.
Построить в Graphana dashboard, показывающий распределение запросов по сервисам.

### Результат выполнения: 

docker compose файл, запустив который можно перейти по адресу http://localhost:8081, по которому доступна Grafana с настроенным Dashboard.
Логин в Grafana должен быть admin, пароль qwerty123456.

---

### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---